<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE com.amazon.aws.CloudFormation.Stack.Generate SYSTEM "../dtd/Generate-Request.dtd">
<com.amazon.aws.CloudFormation.Stack.Generate>
    <ControlAreaRequest messageCategory="com.amazon.aws.CloudFormation" messageObject="Stack"
        messageAction="Generate" messageRelease="1.0" messagePriority="9" messageType="Request">
        <Sender>
            <MessageId>
                <SenderAppId>org.usda.ars.TestSuiteApplication</SenderAppId>
                <ProducerId>4860446b-1e16-4bc0-8d0a-af7675956591 </ProducerId>
                <MessageSeq>1024</MessageSeq>
            </MessageId>
            <Authentication>
                <AuthUserId>testsuiteapp@emory.edu/127.0.0.1</AuthUserId>
            </Authentication>
        </Sender>
        <Datetime>
            <Year>2016</Year>
            <Month>8</Month>
            <Day>17</Day>
            <Hour>13</Hour>
            <Minute>47</Minute>
            <Second>30</Second>
            <SubSecond>842</SubSecond>
            <Timezone>6:00-GMT</Timezone>
        </Datetime>
        <ExpectedReplyFormat messageCategory="com.amazon.aws.CloudFormation" messageObject="Stack"
            messageAction="Response" messageRelease="1.0" messageType="Reply"/>
    </ControlAreaRequest>
    <DataArea>
        <StackRequisition>
            <AccountId>396417686506</AccountId>
            <StackName>EmoryType1-1</StackName>
            <Description>Emory AWS CloudFormation Template for a type 1 VPC: Extension of Emory
                Network with All Access through Emory</Description>
            <TemplateBody>
                <![CDATA[
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Emory AWS CloudFormation Template for a type 1 VPC: Extension of Emory Network with All Access through Emory",
    "Parameters": {
        "VPCCIDR": {
            "Type": "String",
            "Description": "IP Address range for the VPN connected VPC",
            "MinLength": "9",
            "MaxLength": "18",
            "Default": "10.64.60.0/23",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
        },
        "PublicSubnetCIDR": {
            "Type": "String",
            "Description": "IP Address range for the VPN connected Subnet",
            "MinLength": "9",
            "MaxLength": "18",
            "Default": "10.64.60.0/24",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
        },
        "PrivateSubnetCIDR": {
            "Type": "String",
            "Description": "IP Address range for the VPN connected Subnet",
            "MinLength": "9",
            "MaxLength": "18",
            "Default": "10.64.61.0/24",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
        },
        "VPNAddress": {
            "Type": "String",
            "Description": "IP Address of your VPN device",
            "MinLength": "7",
            "MaxLength": "15",
            "Default": "163.246.8.67",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})",
            "ConstraintDescription": "must be a valid IP address of the form x.x.x.x"
        }
    },
    "Resources": {
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Description": "A Virtual Private Cloud with DNS enabled, Emory assigned CIDR block, a tag identifying the VPC type and CloudFormation stack name.",
            "Properties": {
                "EnableDnsSupport": "true",
                "EnableDnsHostnames": "true",
                "CidrBlock": {"Ref": "VPCCIDR"},
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {"Ref": "AWS::StackName"}
                    },
                    {
                        "Key": "EmoryVpcType",
                        "Value": "1"
                    }
                ]
            }
        },
        "PublicSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Description": "This subnet for internet-facing components of applications such as web servers and load balancers. While this is not truly a public subnet, because all access to the VPC is through the Emory network and existing Emory network controls Emory retains that terminology to align with AWS documentation.",
            "Properties": {
                "VpcId": {"Ref": "VPC"},
                "CidrBlock": {"Ref": "PublicSubnetCIDR"},
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {"Ref": "AWS::StackName"}
                    },
                    {
                        "Key": "Network",
                        "Value": "VPN Connected Subnet"
                    }
                ]
            }
        },
        "PrivateSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Description": "This subnet is for non-internet-facing components of applications such as databases and compute clusters.",
            "Properties": {
                "VpcId": {"Ref": "VPC"},
                "CidrBlock": {"Ref": "PrivateSubnetCIDR"},
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {"Ref": "AWS::StackName"}
                    },
                    {
                        "Key": "Network",
                        "Value": "VPN Connected Subnet"
                    }
                ]
            }
        },
        "VPNGateway": {
            "Type": "AWS::EC2::VPNGateway",
            "Description": "The VPN Gateway is the VPN concentrator on the Amazon side of the VPN connection.",
            "Properties": {
                "Type": "ipsec.1",
                "Tags": [{
                    "Key": "Application",
                    "Value": {"Ref": "AWS::StackName"}
                }]
            }
        },
        "VPNGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Description": "The VPN Gateway Attachment attaches a VPN Gateway to a specific VPC.",
            "Properties": {
                "VpcId": {"Ref": "VPC"},
                "VpnGatewayId": {"Ref": "VPNGateway"}
            }
        },
        "CustomerGateway": {
            "Type": "AWS::EC2::CustomerGateway",
            "Description": "The Customer Gateway describes a physical device or software application on the Emory side of the VPN connection.",
            "Properties": {
                "Type": "ipsec.1",
                "BgpAsn": "65000",
                "IpAddress": {"Ref": "VPNAddress"},
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {"Ref": "AWS::StackName"}
                    },
                    {
                        "Key": "VPN",
                        "Value": {"Fn::Join": [
                            "",
                            [
                                "Gateway to ",
                                {"Ref": "VPNAddress"}
                            ]
                        ]}
                    }
                ]
            }
        },
        "VPNConnection": {
            "Type": "AWS::EC2::VPNConnection",
            "Description": "A VPN Connection associates a VPN Gateway on the AWS side with a Customer Gateway on the Emory side.",
            "Properties": {
                "Type": "ipsec.1",
                "StaticRoutesOnly": "false",
                "CustomerGatewayId": {"Ref": "CustomerGateway"},
                "VpnGatewayId": {"Ref": "VPNGateway"}
            }
        },
        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Description": "This is a route table for the private subnet.",
            "Properties": {
                "VpcId": {"Ref": "VPC"},
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {"Ref": "AWS::StackName"}
                    },
                    {
                        "Key": "Network",
                        "Value": "VPN Connected Subnet"
                    }
                ]
            }
        },
        "PrivateSubnetRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Description": "This associates the private route table with the private subnet.",
            "Properties": {
                "SubnetId": {"Ref": "PrivateSubnet"},
                "RouteTableId": {"Ref": "PrivateRouteTable"}
            }
        },
        "PrivateRoute": {
            "Type": "AWS::EC2::Route",
            "Description": "This is a route table for the private subnet that routes traffic bound for the internet our through the VPN Gateway to the Emory network.",
            "DependsOn": "VPNGatewayAttachment",
            "Properties": {
                "RouteTableId": {"Ref": "PrivateRouteTable"},
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {"Ref": "VPNGateway"}
            }
        },
        "PrivateNetworkAcl": {
            "Type": "AWS::EC2::NetworkAcl",
            "Description": "This is a Network ACL for the private network.",
            "Properties": {
                "VpcId": {"Ref": "VPC"},
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {"Ref": "AWS::StackName"}
                    },
                    {
                        "Key": "Network",
                        "Value": "Private"
                    }
                ]
            }
        },
        "InboundPrivateNetworkAclEntry": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Description": "Todo: implement real, appropriate NACLs",
            "Properties": {
                "NetworkAclId": {"Ref": "PrivateNetworkAcl"},
                "RuleNumber": "100",
                "Protocol": "6",
                "RuleAction": "allow",
                "Egress": "false",
                "CidrBlock": "0.0.0.0/0",
                "PortRange": {
                    "From": "0",
                    "To": "65535"
                }
            }
        },
        "OutBoundPrivateNetworkAclEntry": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Description": "Todo: implement real, apropriate NACLs",
            "Properties": {
                "NetworkAclId": {"Ref": "PrivateNetworkAcl"},
                "RuleNumber": "100",
                "Protocol": "6",
                "RuleAction": "allow",
                "Egress": "true",
                "CidrBlock": "0.0.0.0/0",
                "PortRange": {
                    "From": "0",
                    "To": "65535"
                }
            }
        },
        "PrivateSubnetNetworkAclAssociation": {
            "Type": "AWS::EC2::SubnetNetworkAclAssociation",
            "Description": "This associates the private network ACL with the private network.",
            "Properties": {
                "SubnetId": {"Ref": "PrivateSubnet"},
                "NetworkAclId": {"Ref": "PrivateNetworkAcl"}
            }
        },
        "AdministratorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "Administrator",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [{
                        "Effect": "Allow",
                        "Principal": {"Federated": "arn:aws:iam::698677649721:saml-provider/Emory_QA_IDP"},
                        "Action": "sts:AssumeRoleWithSAML",
                        "Condition": {"StringEquals": {
                            "saml:aud": "https://signin.aws.amazon.com/saml",
                            "saml:iss": "https://login.emory.edu:4443/idp/shibboleth"
                        }}
                    }]
                },
                "Path": "/"
            }
        },
        "AdminRolePolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "Description": "This policy allows customer administrators with broad, but restricted access to their account.  It has a devault allow posture and then denies specific services and operations.",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        },
                        {
                            "Effect": "Deny",
                            "Action": [
                                "iam:*",
                                "route53:*",
                                "ec2:*SecurityGroup*",
                                "ec2:AcceptVpcPeeringConnection",
                                "ec2:AssociateDhcpOptions",
                                "ec2:AssociateRouteTable",
                                "ec2:AttachClassicLinkVpc",
                                "ec2:AttachInternetGateway",
                                "ec2:AttachNetworkInterface",
                                "ec2:AttachVpnGateway",
                                "ec2:CreateCustomerGateway",
                                "ec2:CreateDhcpOptions",
                                "ec2:CreateFlowLogs",
                                "ec2:CreateInternetGateway",
                                "ec2:CreateNatGateway",
                                "ec2:CreateRoute",
                                "ec2:CreateRouteTable",
                                "ec2:CreateSubnet",
                                "ec2:CreateVpc",
                                "ec2:CreateVpcEndpoint",
                                "ec2:CreateVpcPeeringConnection",
                                "ec2:CreateVpnConnection",
                                "ec2:CreateVpnConnectionRoute",
                                "ec2:CreateVpnGateway",
                                "ec2:DeleteCustomerGateway",
                                "ec2:DeleteDhcpOptions",
                                "ec2:DeleteFlowLogs",
                                "ec2:DeleteInternetGateway",
                                "ec2:DeleteNatGateway",
                                "ec2:DeleteRoute",
                                "ec2:DeleteRouteTable",
                                "ec2:DeleteSubnet",
                                "ec2:DeleteVpc",
                                "ec2:DeleteVpcEndpoints",
                                "ec2:DeleteVpcPeeringConnection",
                                "ec2:DeleteVpnConnection",
                                "ec2:DeleteVpnConnectionRoute",
                                "ec2:DeleteVpnGateway",
                                "ec2:DetachClassicLinkVpc",
                                "ec2:DetachInternetGateway",
                                "ec2:DetachVpnGateway",
                                "ec2:DisableVgwRoutePropagation",
                                "ec2:DisableVpcClassicLink",
                                "ec2:DisassociateRouteTable",
                                "ec2:EnableVgwRoutePropagation",
                                "ec2:EnableVpcClassicLink",
                                "ec2:ModifySubnetAttribute",
                                "ec2:ModifyVpcAttribute",
                                "ec2:ModifyVpcEndpoint",
                                "ec2:MoveAddressToVpc",
                                "ec2:RejectVpcPeeringConnection",
                                "ec2:ReplaceRoute",
                                "ec2:ReplaceRouteTableAssociation"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Roles": [{"Ref": "AdministratorRole"}]
            },
            "DependsOn": "AdministratorRole"
        },
        "CentralAdministratorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "CentralAdministrator",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [{
                        "Effect": "Allow",
                        "Principal": {"Federated": "arn:aws:iam::698677649721:saml-provider/Emory_QA_IDP"},
                        "Action": "sts:AssumeRoleWithSAML",
                        "Condition": {"StringEquals": {
                            "saml:aud": "https://signin.aws.amazon.com/saml",
                            "saml:iss": "https://login.emory.edu:4443/idp/shibboleth"
                        }}
                    }]
                },
                "Path": "/",
                "Policies": [{
                    "PolicyName": "root",
                    "PolicyDocument": {
                        "Version": "2012-10-17",
                        "Statement": [{
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }]
                    }
                }]
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPCId of the newly created VPC",
            "Value": {"Ref": "VPC"}
        },
        "PrivateSubnet": {
            "Description": "SubnetId of the VPN connected subnet",
            "Value": {"Ref": "PrivateSubnet"}
        }
    }
}
]]>
            </TemplateBody>
            <DisableRollback>fasle</DisableRollback>
            <StackParameter>
                <Key>PrivateSubnetCIDR</Key>
                <Value>10.64.61.0/24</Value>
            </StackParameter>
            <StackParameter>
                <Key>PublicSubnetCIDR</Key>
                <Value>10.64.60.0/24</Value>
            </StackParameter>
            <StackParameter>
                <Key>VPCCIDR</Key>
                <Value>10.64.60.0/23</Value>
            </StackParameter>
            <StackParameter>
                <Key>VPNAddress</Key>
                <Value>163.246.8.67</Value>
            </StackParameter>
            <Capability>CAPABILITY_IAM</Capability>
            <Capability>CAPABILITY_NAMED_IAM</Capability>
            <Tag>
                <Key>TemplateName</Key>
                <Value>EmoryVpcType1</Value>
            </Tag>
        </StackRequisition>
    </DataArea>
</com.amazon.aws.CloudFormation.Stack.Generate>
